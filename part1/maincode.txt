<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>华容道游戏测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .game-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 40px;
            font-size: 36px;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            font-size: 24px;
        }
        
        .board {
            display: grid;
            grid-template-columns: repeat(5, 120px);
            grid-template-rows: repeat(4, 120px);
            gap: 0;
            background-color: #f0f0f0;
            margin: 0 auto 40px;
            padding: 0;
            border-radius: 10px;
            position: relative;
            width: 630px;
            height: 510px;
            border: 15px solid #8B4513;
            box-sizing: content-box;
        }
        
        .board::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 135px;
            width: 240px;
            height: 15px;
            background-color: #FFD700;
            border-radius: 0 0 10px 10px;
            border-top: 2px solid #FFD700;
        }
        
        .cell {
            width: 120px;
            height: 120px;
            background-color: #f0f0f0;
            border-radius: 6px;
        }
        
        .piece {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            border-radius: 3px;
            transition: transform 0.2s ease;
            z-index: 10;
        }
        
        .piece:hover {
            opacity: 0.8;
        }
        
        .piece.cao-cao {
            background-image: url('lll.png');
            background-size: cover;
            background-position: center;
            color: white;
            width: 240px;
            height: 240px;
        }
        
        .piece.general {
            color: white;
        }
        
        .piece.general.horizontal {
            background-image: url('2.png');
            background-size: cover;
            background-position: center;
            width: 240px;
            height: 120px;
        }
        
        .piece.general.vertical {
            background-image: url('1.png');
            background-size: cover;
            background-position: center;
            width: 120px;
            height: 240px;
        }
        
        .piece.soldier {
            background-image: url('3.png');
            background-size: cover;
            background-position: center;
            color: white;
            width: 120px;
            height: 120px;
        }
        
        .controls {
            margin-top: 40px;
        }
        
        button {
            padding: 20px 40px;
            margin: 0 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .level-selector {
            margin: 30px 0;
        }
        
        select {
            padding: 16px;
            font-size: 20px;
            border-radius: 10px;
            border: 2px solid #ddd;
        }
        
        .message {
            margin-top: 40px;
            padding: 20px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 20px;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .message.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>华容道游戏</h1>
        
        
        
        <div class="board" id="board">
            <!-- 棋盘格子将通过JavaScript生成 -->
        </div>
        
        <div class="controls">
            <button onclick="resetGame()">重新开始</button>
            <button onclick="undoMove()">撤销</button>
        </div>
        
        <div class="message" id="message"></div>
    </div>
    
    <script>
        // 初始棋子位置
        const initialPieces = [
            { type: 'cao-cao', x: 1, y: 0, width: 2, height: 2, label: '' },
            { type: 'general', x: 0, y: 0, width: 1, height: 2, label: '', orientation: 'vertical' },
            { type: 'general', x: 3, y: 0, width: 1, height: 2, label: '', orientation: 'vertical' },
            { type: 'general', x: 1, y: 2, width: 2, height: 1, label: '', orientation: 'horizontal' },
            { type: 'soldier', x: 0, y: 2, width: 1, height: 1, label: '' },
            { type: 'soldier', x: 3, y: 2, width: 1, height: 1, label: '' },
            { type: 'soldier', x: 0, y: 3, width: 1, height: 1, label: '' },
            { type: 'soldier', x: 1, y: 3, width: 1, height: 1, label: '' },
            { type: 'soldier', x: 2, y: 3, width: 1, height: 1, label: '' },
            { type: 'soldier', x: 3, y: 3, width: 1, height: 1, label: '' }
        ];
        
        // 游戏状态
        let gameState = {
            board: Array(4).fill().map(() => Array(5).fill(null)),
            pieces: JSON.parse(JSON.stringify(initialPieces)),
            history: [],
            selectedPiece: null,
            canleave: 1
        };
        
        // 初始化棋盘
        function initBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 5; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    board.appendChild(cell);
                }
            }
        }
        
        // 更新棋盘
        function updateBoard() {
            const board = document.getElementById('board');
            
            // 清除现有棋子
            const existingPieces = board.querySelectorAll('.piece');
            existingPieces.forEach(piece => piece.remove());
            
            // 清除现有出口标志
            const existingExit = board.querySelector('.exit');
            if (existingExit) {
                existingExit.remove();
            }
            
            // 清除现有钥匙图标
            const existingKey = board.querySelector('.key');
            if (existingKey) {
                existingKey.remove();
            }
            
            // 检查曹操是否在钥匙位置
            const caoCao = gameState.pieces.find(piece => piece.type === 'cao-cao');
            // 只要曹操的任何一部分碰到钥匙就算
            const isCaoCaoOnKey = caoCao && !(caoCao.x > 3 || caoCao.x + caoCao.width <= 3 || caoCao.y > 2 || caoCao.y + caoCao.height <= 2);
            
            // 如果曹操碰到钥匙且还没找到钥匙，标记为找到钥匙
            if (isCaoCaoOnKey && gameState.canleave === 1) {
                showMessage('发现了钥匙！', 'info');
                gameState.canleave = 0;
            }
            
            // 只有当还没找到钥匙时才显示钥匙图标
            if (gameState.canleave === 1) {
                const keyElement = document.createElement('div');
                keyElement.className = 'key';
                keyElement.style.position = 'absolute';
                keyElement.style.left = `${15 + 3 * 120}px`;
                keyElement.style.top = `${15 + 2 * 120}px`;
                keyElement.style.width = '120px';
                keyElement.style.height = '120px';
                keyElement.style.zIndex = '1';
                keyElement.style.backgroundImage = 'url("4.png")';
                keyElement.style.backgroundSize = 'cover';
                keyElement.style.backgroundPosition = 'center';
                board.appendChild(keyElement);
            }
            
            // 清除现有锁图标
            const existingLock = board.querySelector('.lock');
            if (existingLock) {
                existingLock.remove();
            }
            
            // 添加锁图标（如果曹操还没找到钥匙）
            if (gameState.canleave === 1) {
                const lockElement = document.createElement('div');
                lockElement.className = 'lock';
                lockElement.style.position = 'absolute';
                lockElement.style.left = `${15 + 1 * 120}px`;
                lockElement.style.top = `${15 + 2 * 120 + 220}px`;
                lockElement.style.width = '240px';
                lockElement.style.height = '120px';
                lockElement.style.zIndex = '1';
                lockElement.innerHTML = '<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="30" y="40" width="40" height="40" rx="5" fill="#8B4513"/><rect x="40" y="30" width="20" height="20" rx="5" fill="#8B4513"/><circle cx="50" cy="60" r="10" fill="#FFD700"/></svg>';
                lockElement.style.display = 'flex';
                lockElement.style.justifyContent = 'center';
                lockElement.style.alignItems = 'center';
                board.appendChild(lockElement);
            }
            
            // 重置棋盘状态
            gameState.board = Array(4).fill().map(() => Array(5).fill(null));
            
            // 添加新棋子
            gameState.pieces.forEach((piece, index) => {
                const pieceElement = document.createElement('div');
                pieceElement.className = `piece ${piece.type}`;
                
                if (piece.type === 'general') {
                    pieceElement.classList.add(piece.orientation);
                }
                
                pieceElement.textContent = piece.label;
                pieceElement.style.left = `${15 + piece.x * 120}px`;
                pieceElement.style.top = `${15 + piece.y * 120}px`;
                pieceElement.dataset.index = index;
                
                pieceElement.addEventListener('click', () => selectPiece(index));
                pieceElement.addEventListener('mousedown', startDrag);
                
                board.appendChild(pieceElement);
                
                // 更新棋盘状态
                for (let y = piece.y; y < piece.y + piece.height; y++) {
                    for (let x = piece.x; x < piece.x + piece.width; x++) {
                        if (y < 4 && x < 5) {
                            gameState.board[y][x] = index;
                        }
                    }
                }
            });
        }
        
        // 选择棋子
        function selectPiece(index) {
            gameState.selectedPiece = index;
        }
        
        // 开始拖动
        function startDrag(e) {
            const pieceIndex = parseInt(e.target.dataset.index);
            gameState.selectedPiece = pieceIndex;
            
            const startX = e.clientX;
            const startY = e.clientY;
            const piece = gameState.pieces[pieceIndex];
            
            function onMouseMove(e) {
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                // 计算移动方向
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    // 水平移动
                    if (deltaX > 30) {
                        movePiece(pieceIndex, 1, 0);
                        document.removeEventListener('mousemove', onMouseMove);
                    } else if (deltaX < -30) {
                        movePiece(pieceIndex, -1, 0);
                        document.removeEventListener('mousemove', onMouseMove);
                    }
                } else {
                    // 垂直移动
                    if (deltaY > 30) {
                        movePiece(pieceIndex, 0, 1);
                        document.removeEventListener('mousemove', onMouseMove);
                    } else if (deltaY < -30) {
                        movePiece(pieceIndex, 0, -1);
                        document.removeEventListener('mousemove', onMouseMove);
                    }
                }
            }
            
            function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }
        
        // 移动棋子
        function movePiece(index, dx, dy) {
            const piece = gameState.pieces[index];
            const newX = piece.x + dx;
            const newY = piece.y + dy;
            
            // 检查移动是否合法
            if (isValidMove(index, newX, newY)) {
                // 保存历史记录
                gameState.history.push(JSON.parse(JSON.stringify(gameState.pieces)));
                
                // 更新棋子位置
                piece.x = newX;
                piece.y = newY;
                
                // 更新棋盘
                updateBoard();
                
                // 检查是否胜利
                checkWin();
            }
        }
        
        // 检查移动是否合法
        function isValidMove(index, newX, newY) {
            const piece = gameState.pieces[index];
            
            // 检查边界
            if (newX < 0 || newY < 0 || newX + piece.width > 5 || newY + piece.height > 4) {
                return false;
            }
            
            // 检查是否与其他棋子重叠
            for (let y = newY; y < newY + piece.height; y++) {
                for (let x = newX; x < newX + piece.width; x++) {
                    if (gameState.board[y][x] !== null && gameState.board[y][x] !== index) {
                        return false;
                    }
                }
            }
            
            return true;
        }
        
        // 检查是否胜利
        function checkWin() {
            const caoCao = gameState.pieces.find(piece => piece.type === 'cao-cao');
            if (caoCao && caoCao.x === 1 && caoCao.y === 2) {
                // 曹操到达出口位置
                if (gameState.canleave === 1) {
                    // 还没找到钥匙
                    showMessage('还没找到钥匙呢', 'info');
                } else {
                    // 找到了钥匙，获胜
                    showMessage('恭喜你获胜了！', 'success');
                }
            }
        }
        
        // 重置游戏
        function resetGame() {
            console.log('重置游戏');
            gameState.history = [];
            gameState.selectedPiece = null;
            gameState.canleave = 1;
            gameState.pieces = JSON.parse(JSON.stringify(initialPieces));
            updateBoard();
            document.getElementById('message').textContent = '';
            document.getElementById('message').className = 'message';
        }
        
        // 撤销移动
        function undoMove() {
            if (gameState.history.length > 0) {
                gameState.pieces = gameState.history.pop();
                updateBoard();
            }
        }
        
        // 显示消息
        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = `message ${type}`;
            
            setTimeout(() => {
                message.textContent = '';
                message.className = 'message';
            }, 2000);
        }
        
        // 初始化游戏
        function initGame() {
            console.log('开始初始化游戏');
            initBoard();
            console.log('棋盘初始化完成');
            updateBoard();
            console.log('游戏初始化完成');
        }
        
        // 页面加载完成后初始化游戏
        window.onload = initGame;
        
        // 键盘控制
        window.addEventListener('keydown', (e) => {
            if (gameState.selectedPiece !== null) {
                switch (e.key) {
                    case 'ArrowUp':
                        movePiece(gameState.selectedPiece, 0, -1);
                        break;
                    case 'ArrowDown':
                        movePiece(gameState.selectedPiece, 0, 1);
                        break;
                    case 'ArrowLeft':
                        movePiece(gameState.selectedPiece, -1, 0);
                        break;
                    case 'ArrowRight':
                        movePiece(gameState.selectedPiece, 1, 0);
                        break;
                }
            }
        });
    </script>
</body>
</html>